#!/bin/sh

failures=0
RC=0

subhook_root=hooks/commit_hooks
tmpdir=`mktemp -d`

while read oldrev newrev refname; do
    for changedfile in `git diff-tree --no-commit-id --name-only -r $newrev --diff-filter=ACM`; do
        tmpmodule="$tmpdir/$changedfile"
        tmperror="$tmpdir/errors.txt"
        mkdir -p $tmpmodule
        rmdir $tmpmodule
        git show $newrev:$changedfile > $tmpmodule

        #check puppet manifest syntax
        if type puppet >/dev/null 2>&1; then
            if [ $(echo $changedfile | grep -q '\.*.pp$'; echo $?) -eq 0 ]; then
                ${subhook_root}/puppet_manifest_syntax_check.sh $tmpmodule
                RC=$?
                if [ "$RC" -ne 0 ]; then
                    failures=`expr $failures + 1`
                fi
            fi
        else
            echo "puppet not installed. Skipping puppet syntax checks..."
        fi

        if type ruby >/dev/null 2>&1; then
            #check erb (template file) syntax
            if type erb >/dev/null 2>&1; then
                if [ $(echo $changedfile | grep -q '\.*.erb$'; echo $?) -eq 0 ]; then
                    ${subhook_root}/erb_template_syntax_check.sh $tmpmodule
                    RC=$?
                    if [ "$RC" -ne 0 ]; then
                        failures=`expr $failures + 1`
                    fi
                fi
            else
                echo "erb not installed. Skipping erb template checks..."
            fi

            #check hiera data (yaml/yml) syntax
            if [ $(echo $changedfile | grep -q '\.*.yaml$\|\.*.yml$'; echo $?) -eq 0 ]; then 
                ${subhook_root}/yaml_syntax_check.sh $tmpmodule
                RC=$?
                if [ "$RC" -ne 0 ]; then
                    failures=`expr $failures + 1`
                fi
            fi
        else
            echo "ruby not installed. Skipping erb/yaml checks..."
        fi

        #puppet manifest styleguide compliance
        if type puppet-lint >/dev/null 2>&1; then
            if [ $(echo $changedfile | grep -q '\.*.pp$' ; echo $?) -eq 0 ]; then 
                ${subhook_root}/puppet_lint_checks.sh $tmpmodule
                RC=$?
                if [ "$RC" -ne 0 ]; then
                    failures=`expr $failures + 1`
                fi
            fi
        else
            echo "puppet-lint not installed. Skipping puppet-lint tests..."
        fi
    done
done

#rspec test validation
if which rspec >/dev/null 2>&1; then
    ${subhook_root}/rspec_puppet_checks.sh
    RC=$?
    if [ "$RC" -ne 0 ]; then
        failures=`expr $failures + 1`
    fi
else
    echo "rspec not installed. Skipping rspec-puppet tests..."
fi

#summary
if [ "$failures" -ne 0 ]; then
    echo "Error: $failures subhooks failed. Aborting commit."
    exit 1
fi

exit 0
